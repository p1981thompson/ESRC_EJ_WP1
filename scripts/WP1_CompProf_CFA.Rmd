---
title: "WP1: Profiles of comprehension difficulty - Data Pre-processing and CFA"
output: 
  html_document:
    toc: true
    toc_float: true
date: '18/10/2021'
    
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output/analysis/") })
---

This script computes basic summary statistics for the data, ensures that they align with Mplus output, and tests the factor structure to be used for subsequent analyses. This analysis is conducted on the poor comprehender group extracted from the SimpView analysis; the final profiles are documented in WP1_SimpView_FinalProfiles.Rmd. The pre-registration for this analysis can be found [here](https://osf.io/4zahf).

# Set-up

## Libraries

```{r libraries, message = FALSE, warnings = FALSE}
# List packages
pkgs <- c("tidyverse", "psych", "naniar", "kableExtra", "MplusAutomation", "texreg", "semPlot")

# Load packages (version info detailed at the end of the script)
invisible(lapply(pkgs, library, character.only = TRUE))
```

## Directories

```{r create-dir}
# Create subdirectories for storing mplus scripts, data files, and output, if do not already exist
if(dir.exists("./mplus_models/")==FALSE){dir.create("./mplus_models/")}
if(dir.exists("./mplus_models/compprof/")==FALSE){dir.create("./mplus_models/compprof/")}
if(dir.exists("./mplus_models/compprof/desc")==FALSE){dir.create("./mplus_models/compprof/desc")}
if(dir.exists("./mplus_models/compprof/cfa")==FALSE){dir.create("./mplus_models/compprof/cfa")} 
```

##  Data

Read in the original data file extracted for WP1 (contains all variables) and the classes extracted from the previous analysis. Filter dataset to include only the classes of interest for this analysis (those with poor comprehension in the context of relatively good reading accuracy). 

```{r load-data}
# Load all variables
cp_data <- read.csv("../data/processed/WP1_data_all.csv") %>% 
  select(cidB3153, yp_id,
         nara_comp_raw_f9, nara_acc_raw_f9, read_word_raw_f9, read_nonw_raw_f9, wold_comp_raw_f8,
         age_m_f8, age_m_f9, age_m_f10,
         nara_rate_raw_f9,
         wold_vcb_raw_f8, wisc_vcb_raw_f8,
         wisc_pcmp_raw_f8, wisc_code_raw_f8, wisc_parr_raw_f8, wisc_bloc_raw_f8, wisc_obja_raw_f8,
         wisc_bwsp_raw_f8, cntsp_span_raw_f10,
         teach_slct_raw_f8, teach_divd_raw_f8, teach_ctr_diff_f8,
         sdq_hyp_prnt_ku) %>% 
  mutate(read_comb_raw_f9 = (read_word_raw_f9 + read_nonw_raw_f9)) %>% 
  select(- c(read_word_raw_f9, read_nonw_raw_f9))

# Load class data
class_data <- read.csv("../data/processed/WP1_data_profiles.csv")  

# Merge class data and filter for group of interest 
cp_data <- cp_data %>% 
  left_join(class_data, by = c("cidB3153",
                             "age_m_f8" = "f8age",
                             "age_m_f9" = "f9age")) %>% 
  filter(c == 1)
```

Mplus has an 8-character limit, so rename relevant variables with short names for modelling. 

```{r mplus-names}
# Rename any necessary, print new names
cp_data <- cp_data %>% 
  rename(naraComp = nara_comp_raw_f9,
         naraAcc = nara_acc_raw_f9,
         combAcc = read_comb_raw_f9,
         woldComp = wold_comp_raw_f8,
         f8age = age_m_f8,
         f9age = age_m_f9,
         f10age = age_m_f10,
         naraRate = nara_rate_raw_f9,
         woldVcb = wold_vcb_raw_f8,
         wiscVcb = wisc_vcb_raw_f8,
         wiscPcmp = wisc_pcmp_raw_f8,
         wiscCode = wisc_code_raw_f8,
         wiscParr = wisc_parr_raw_f8,
         wiscBloc = wisc_bloc_raw_f8,
         wiscObja = wisc_obja_raw_f8,
         wiscBwsp = wisc_bwsp_raw_f8,
         cntspan = cntsp_span_raw_f10,
         attnSel = teach_slct_raw_f8,
         attnDiv = teach_divd_raw_f8,
         attnOpp = teach_ctr_diff_f8,
         sdqHyp = sdq_hyp_prnt_ku) %>% 
  mutate(yp_id = as.factor(yp_id))  # re-format as factor

# Check compatibility with mplus
str_sub(names(cp_data), 1, 8)
```


# Descriptive statistics

Extract summary statistics for each variable.

```{r summary-stats}
# Summary statistics
cp_data %>%
  select(-cidB3153, -yp_id, -c) %>%
  describe() %>% 
  kable("pipe")

# Visualise missingness
vis_miss(cp_data, cluster = TRUE)
```

Patterns of missingness are more thoroughly explored for all WP1 variables in the initial data processing script. There is a higher proportion of missingness than in the SimpView analysis as there were more measures collected from across three different clinics. 

```{r correlations}
# Correlations
cp_data %>% 
  select(-c, -yp_id, -cidB3153, -g, -f8age, -f9age, -f10age) %>% 
  cor(use = "pairwise.complete.obs") %>% 
  round(digits = 2) %>% 
  kable("pipe")
```

### Check that Mplus reading data as expected

Extract descriptive statistics as check.

```{r mplus-desc}
# Specify model
m_desc <- mplusObject(
  TITLE = "Data check - Descriptive statistics;",
  ANALYSIS = "type = basic;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c")]),
  rdata = cp_data)


# Fit model 
m_desc_fit <- mplusModeler(m_desc,
                            dataout = "./mplus_models/compprof/desc/cp_sim.dat",
                            modelout = "./mplus_models/compprof/desc/cp_check.inp",
                            check = TRUE, run = FALSE, hashfilename = TRUE)

# Read mplus output
m_desc_out <- readModels("./mplus_models/compprof/desc/cp_check.out")

# Check that sample sizes and means match descriptive statistics from above
r_summ <- describe(cp_data) %>%
  as.data.frame() %>% 
  slice(3:24) %>% 
  select(n, mean) %>% 
  round(., 2)
mplus_summ <- m_desc_out$sampstat$univariate.sample.statistics %>% 
  as.data.frame() %>%
  round(.,2) %>% 
  select(`Sample Size`, Mean) %>% 
  set_names(c("n", "mean"))

if (any((r_summ - mplus_summ) > abs(0.01))){
  print("WARNING: DIFFERENCES DETECTED BETWEEN R AND MPLUS DATA SUMMARIES. Inspect output.")
  setdiff(mplus_summ, r_summ)
  } else{
      print("Data check passed")
  }
```


# Confirmatory Factor Analysis

## Testing the 5-factor structure

Fit the proposed factorial model.

```{r cfa-initial-fit}
# Proposed factor structure: 5 factors + rate
m_cfa1a <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - 5-factor + rate;",
  ANALYSIS = "estimator = mlr; type = general; starts = 20;",
  MODEL = " f8age; f9age; f10age;
            acc naraRate naraComp on f9age;
            vocab perfiq woldComp wiscBwsp attnSel attnDiv attnOpp on f8age;
            cntSpan on f10age;
            acc by combAcc naraAcc; 
            comp by woldComp naraComp;
            naraRate;
            vocab by wiscVcb woldVcb;
            perfiq by wiscPcmp wiscCode wiscParr wiscBloc wiscObja;
            execfun by wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp;
            acc with comp; acc with naraRate; acc with vocab; 
            acc with perfiq; acc with execfun;
            comp with naraRate; comp with vocab; 
            comp with perfiq; comp with execfun;
            naraRate with vocab; naraRate with perfiq; 
            naraRate with execfun; 
            vocab with perfiq; vocab with execfun;
            perfiq with execfun;",
  DEFINE = "naraAcc = naraAcc/5; naraRate = naraRate/8; wiscVcb = wiscVcb/2;
            wiscPcmp = wiscPcmp/2; wiscCode = wiscCode/5; wiscParr = wiscParr/5;
            wiscBloc = wiscBloc/6; wiscObja = wiscObja/5; attnDiv = attnDiv/20; 
            attnOpp = attnOpp/4;",
  OUTPUT = "TECH1; TECH4; stdyx; modindices;",
  PLOT = "TYPE = PLOT3;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c", "g")]),
  rdata = cp_data)

m_cfa1a_fit <- mplusModeler(m_cfa1a,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa1a.inp",
                           check = TRUE, run = TRUE)
m_cfa1a_fit$results$warnings

# Model gives error with naraAcc residual variance >> constrain to 0
m_cfa1b <- update(m_cfa1a, 
                  TITLE = ~ "Confirmatory Factor Analysis - 5-factor + rate (naraAcc constrained);",
                  MODEL = ~ . + "naraAcc@0;")

m_cfa1b_fit <- mplusModeler(m_cfa1b,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa1b.inp",
                           check = TRUE, run = TRUE)
m_cfa1b_fit$results$warnings

# Inspect model output
SummaryTable(m_cfa1b_fit, keepCols = c("Title", "Parameters", "LL", "CFI", "TLI", "AIC", "BIC", "RMSEA_Estimate", "RMSEA_pLT05", "SRMR")) %>%
  kable("pipe")

# Inspect modification indices
m_cfa1b_fit$results$mod_indices %>%
  arrange(desc(MI)) %>% 
  head(10) %>%
  kable("pipe") 
```

Although the MIs indicate that correlated residuals between the accuracy variables could improve model fit, doing so would lead to a non-identified model (need to remove constraint first from naraAcc residual variance). The problem seems to lie in the high correlation between the naraComp and naraAcc variables (taken from the same measure;; accuracy errors corrected to assess comprehension independently but still highly influenced by accuracy). Consider a model with a cross-loading between naraComp and the accuracy latent variable. 

```{cfa-crossload}
m_cfa1c <- update(m_cfa1b, 
                  TITLE = ~ "Confirmatory Factor Analysis - 5-factor + rate (naraComp cross-load);",
                  MODEL = ~ . + "acc by naraComp;")
m_cfa1c_fit <- mplusModeler(m_cfa1c,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa1c.inp",
                           check = TRUE, run = TRUE)
m_cfa1c_fit$results$warnings
```

## Testing a 4-factor structure

The proposed factor structure is not a good fit, as vocabulary and comprehension measures are highly correlated. From a Simple View perspective, the vocabulary measures are a component language skill that support comprehension ability, and we would expect them to correlate highly with the listening comprehension measure. Combine the comprehension and vocabulary measures into a single latent variable for language skills. 

```{r cfa-4f}
m_cfa2a <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - 4-factor + rate;",
  ANALYSIS = "estimator = mlr; type = general; starts = 20;",
  MODEL = " f8age; f9age; f10age;
            acc naraRate naraComp on f9age;
            perfiq woldComp wiscBwsp attnSel attnDiv attnOpp on f8age;
            wiscVcb woldVcb on f8age;
            cntSpan on f10age;
            acc by combAcc naraAcc naraComp; 
            naraAcc@0;
            lang by woldComp naraComp wiscVcb woldVcb;
            naraRate;
            perfiq by wiscPcmp wiscCode wiscParr wiscBloc wiscObja;
            execfun by wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp;
            acc with lang; acc with naraRate; 
            acc with perfiq; acc with execfun;
            lang with naraRate; 
            lang with perfiq; lang with execfun;
            naraRate with perfiq; naraRate with execfun; 
            perfiq with execfun;",
  DEFINE = "naraAcc = naraAcc/5; naraRate = naraRate/8; wiscVcb = wiscVcb/2;
            wiscPcmp = wiscPcmp/2; wiscCode = wiscCode/5; wiscParr = wiscParr/5;
            wiscBloc = wiscBloc/6; wiscObja = wiscObja/5; attnDiv = attnDiv/20; 
            attnOpp = attnOpp/4;",
  OUTPUT = "TECH1; TECH4; stdyx; modindices;",
  PLOT = "TYPE = PLOT3;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c", "g")]),
  rdata = cp_data)

m_cfa2a_fit <- mplusModeler(m_cfa2a,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa2a.inp",
                           check = TRUE, run = TRUE)
m_cfa2a_fit$results$warnings

# Inspect model output
SummaryTable(m_cfa2a_fit, keepCols = c("Title", "Parameters", "LL", "CFI", "TLI", "AIC", "BIC", "RMSEA_Estimate", "RMSEA_pLT05", "SRMR")) %>%
  kable("pipe")

# Inspect modification indices
m_cfa2a_fit$results$mod_indices %>%
  arrange(desc(MI)) %>%
  head(10) %>%
  kable("pipe")

# Add correlated residuals between the two accuracy measures (guided by MIs; theoretically sensible as original proposed measures of decoding skill)
m_cfa2b <- update(m_cfa2a, 
                  TITLE = ~ "Confirmatory Factor Analysis - 4-factor + rate (correlated acc residuals);",
                  MODEL = ~ . + "combAcc with naraAcc;")
m_cfa2b_fit <- mplusModeler(m_cfa2b,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa2b.inp",
                           check = TRUE, run = TRUE)
m_cfa2b_fit$results$warnings

# The correlated residuals are incompatible with the constrained residuals previous included, remove the constraint
m_cfa2c <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - 4-factor + rate (unconstrained naraAcc);",
  ANALYSIS = "estimator = mlr; type = general; starts = 20;",
  MODEL = " f8age; f9age; f10age;
            acc naraComp naraRate on f9age;
            perfiq woldComp wiscBwsp attnSel attnDiv attnOpp on f8age;
            wiscVcb woldVcb on f8age;
            cntSpan on f10age;
            acc by combAcc naraAcc naraComp; 
            combAcc with naraAcc;
            lang by woldComp naraComp wiscVcb woldVcb;
            naraRate;
            perfiq by wiscPcmp wiscCode wiscParr wiscBloc wiscObja;
            execfun by wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp;
            acc with lang; acc with naraRate; 
            acc with perfiq; acc with execfun;
            lang with naraRate; 
            lang with perfiq; lang with execfun;
            naraRate with perfiq; naraRate with execfun; 
            perfiq with execfun;",
  DEFINE = "naraAcc = naraAcc/5; naraRate = naraRate/8; wiscVcb = wiscVcb/2;
            wiscPcmp = wiscPcmp/2; wiscCode = wiscCode/5; wiscParr = wiscParr/5;
            wiscBloc = wiscBloc/6; wiscObja = wiscObja/5; attnDiv = attnDiv/20; 
            attnOpp = attnOpp/4;",
  OUTPUT = "TECH1; TECH4; stdyx; modindices;",
  PLOT = "TYPE = PLOT3;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c", "g")]),
  rdata = cp_data)

m_cfa2c_fit <- mplusModeler(m_cfa2c,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa2c.inp",
                           check = TRUE, run = TRUE)
m_cfa2c_fit$results$warnings

# Inspect model output
SummaryTable(m_cfa2c_fit, keepCols = c("Title", "Parameters", "LL", "CFI", "TLI", "AIC", "BIC", "RMSEA_Estimate", "RMSEA_pLT05", "SRMR")) %>%
  kable("pipe")

# Inspect modification indices
m_cfa2c_fit$results$mod_indices %>%
  arrange(desc(MI)) %>%
  head(10) %>%
  kable("pipe")

# Add cross-loading of WISC Coding subtest to EF (guided by MIs)
m_cfa2d <- update(m_cfa2c, 
                  TITLE = ~ "Confirmatory Factor Analysis - 4-factor + rate (Coding cross-loading);",
                  MODEL = ~ . + "execfun by wiscCode;")
m_cfa2d_fit <- mplusModeler(m_cfa2d,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa2d.inp",
                           check = TRUE, run = TRUE)
m_cfa2d_fit$results$warnings

# Inspect model output
SummaryTable(m_cfa2d_fit, keepCols = c("Title", "Parameters", "LL", "CFI", "TLI", "AIC", "BIC", "RMSEA_Estimate", "RMSEA_pLT05", "SRMR")) %>%
  kable("pipe")
``` 

The model is now a good fit. The cross-loading of the WISC Coding subtest (a performance IQ measure) from the executive function construct is theoretically sensible when considering the demands on processing during this task. Children must hold a coding scheme in mind when copying corresponding symbols under timed conditions, placing demands on short-term memory and attention. 

Finally, double check that comprehension cross-loading is necessary (note that for model identification the correlated errors between the two accuracy measures must then be removed, and the residual constraint for naraAcc re-added). Although the naraComp cross-loading is sensible when considering the way in which comprehension was measured during this task, a simpler model would be preferred if possible. 

```{r cross-check}
m_cfa2e <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - 4-factor + rate (no comp cross-load);",
  ANALYSIS = "estimator = mlr; type = general; starts = 20;",
  MODEL = " f8age; f9age; f10age;
            acc naraComp naraRate on f9age;
            perfiq woldComp wiscBwsp attnSel attnDiv attnOpp on f8age;
            wiscVcb woldVcb on f8age;
            cntSpan on f10age;
            acc by combAcc naraAcc; 
            naraAcc@0;
            lang by woldComp naraComp wiscVcb woldVcb;
            naraRate;
            perfiq by wiscPcmp wiscCode wiscParr wiscBloc wiscObja;
            execfun by wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp;
            acc with lang; acc with naraRate; 
            acc with perfiq; acc with execfun;
            lang with naraRate; 
            lang with perfiq; lang with execfun;
            naraRate with perfiq; naraRate with execfun; 
            perfiq with execfun; execfun by wiscCode;
            ",
  DEFINE = "naraAcc = naraAcc/5; naraRate = naraRate/8; wiscVcb = wiscVcb/2;
            wiscPcmp = wiscPcmp/2; wiscCode = wiscCode/5; wiscParr = wiscParr/5;
            wiscBloc = wiscBloc/6; wiscObja = wiscObja/5; attnDiv = attnDiv/20; 
            attnOpp = attnOpp/4;",
  OUTPUT = "TECH1; TECH4; stdyx; modindices;",
  PLOT = "TYPE = PLOT3;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c", "g")]),
  rdata = cp_data)

m_cfa2e_fit <- mplusModeler(m_cfa2e,
                           modelout = "./mplus_models/compprof/cfa/cp_cfa2e.inp",
                           check = TRUE, run = TRUE)

# Inspect model output
SummaryTable(m_cfa2e_fit, keepCols = c("Title", "Parameters", "LL", "CFI", "TLI", "AIC", "BIC", "RMSEA_Estimate", "RMSEA_pLT05", "SRMR")) %>%
  kable("pipe")

# Inspect modification indices
m_cfa2e_fit$results$mod_indices %>%
  arrange(desc(MI)) %>%
  head(10) %>%
  kable("pipe")
```

The model without the cross-loading from naraComp to the accuracy latent variable is poorer in fit, and the MIs support that this modification is key to the difference in fit. Retain cross-loading in final model. 

## Final model

```{r final-model}
readModels("./mplus_models/compprof/cfa/cp_cfa2d.out", what="parameters")$parameters$r2 %>% kable("pipe")
readModels("./mplus_models/compprof/cfa/cp_cfa2d.out", what="parameters")$parameters$stdyx.standardized %>% kable("pipe")
```

This model will be taken forward for cross-validation with subsample B (WP1_SimpView_ShapeValidation.Rmd).


# Version info {#version}

*Package versions were up-to-date as of 12/08/2021.* *LPA models were run using Mplus Version 8.5.*

```{r version}
sessionInfo()
```









```{r exploratory-bifactor-cfa}
# Proposed factor structure: 5 factors + rate
m_bcfa1a <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - Bifactor model;",
  ANALYSIS = "estimator = mlr; type = general; starts = 20;",
  MODEL = " f8age; f9age; f10age;
            acc naraRate naraComp on f9age;
            vocab perfiq woldComp wiscBwsp attnSel attnDiv attnOpp on f8age;
            cntSpan on f10age;
            G by combAcc naraAcc woldComp naraComp naraRate wiscVcb woldVcb
            wiscPcmp wiscCode wiscParr wiscBloc wiscObja
            wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp; 
            acc by combAcc naraAcc; 
            comp by woldComp naraComp;
            naraRate;
            vocab by wiscVcb woldVcb;
            perfiq by wiscPcmp wiscCode wiscParr wiscBloc wiscObja;
            execfun by wiscBwsp cntSpan attnSel attnDiv attnOpp sdqHyp;
            G@1; acc@1; comp@1; naraRate@1; vocab@1; perfiq@1; execfun@1;
            G with acc-execfun@0;
            G with naraRate@0;
            acc-execfun with acc-execfun@0;
            naraRate with acc-execfun@0;
 ",
  DEFINE = "naraAcc = naraAcc/5; naraRate = naraRate/8; wiscVcb = wiscVcb/2;
            wiscPcmp = wiscPcmp/2; wiscCode = wiscCode/5; wiscParr = wiscParr/5;
            wiscBloc = wiscBloc/6; wiscObja = wiscObja/5; attnDiv = attnDiv/20; 
            attnOpp = attnOpp/4;",
  OUTPUT = "TECH1; TECH4; stdyx; modindices;",
  PLOT = "TYPE = PLOT3;",
  usevariables = colnames(cp_data[,!names(cp_data) %in% c("yp_id", "cidB3153", "c", "g")]),
  rdata = cp_data)

m_bcfa1a_fit <- mplusModeler(m_bcfa1a,
                           modelout = "./mplus_models/compprof/cfa/cp_bcfa1a.inp",
                           check = TRUE, run = TRUE)

```