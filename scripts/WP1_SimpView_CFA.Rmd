---
title: "WP1: Simple View - Data Pre-processing and CFA"
output: 
  html_document:
    toc: true
    toc_float: true
date: '25/05/2021'
      
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../output/analysis/") })
---

This script computes basic summary statistics for the data, ensures that they align with Mplus output, and tests the factor structure to be used for subsequent analyses. This analysis is conducted using the "exploratory" or "calibration" half of the dataset (subsample A).

# Set-up

## Libraries

*Package versions were up-to-date as of 12/08/2021. Version information can be found at the [end of the output file](#version).*

*Models were run using Mplus Version 8.5.*

```{r libraries, message = FALSE, warning = FALSE}
# List packages
pkgs <- c("tidyverse", "psych", "naniar", "MplusAutomation", "texreg", "semPlot", "knitr", "kableExtra")

# Load all packages
invisible(lapply(pkgs, library, character.only = TRUE))
```

## Directories

```{r create-dir}
# Create subdirectories for storing mplus scripts, data files, and output, if do not already exist
if(dir.exists("./mplus_models/")==FALSE){dir.create("./mplus_models/")}
if(dir.exists("./mplus_models/simpview/")==FALSE){dir.create("./mplus_models/simpview/")}
if(dir.exists("./mplus_models/simpview/desc")==FALSE){dir.create("./mplus_models/simpview/desc")}
if(dir.exists("./mplus_models/simpview/cfa")==FALSE){dir.create("./mplus_models/simpview/cfa")} 
```

##  Data

This analysis uses only half of the dataset, prior to conducting a finite mixture analysis on the same half. The final mixture model will be cross-validated on the reamining half (WP1_SimpView_CrossValidation.Rmd). 

```{r load-data}
#sv_data <- read.csv("../data/simulated/WP1_SimpView_sim_raw_n1000_k3.csv") # for script testing 

sv_data <- read.csv("../data/processed/WP1_data_subA.csv")  %>%                # ALSPAC data
  dplyr::select(yp_id, cidB3153, age_m_f8, age_m_f9, 
                nara_acc_raw_f9, read_word_raw_f9, read_nonw_raw_f9,  # reading accuracy variables
                nara_comp_raw_f9, wold_comp_raw_f8) %>%               # comprehension variables
  
  # Rename for Mplus character limit
  rename(naraComp = nara_comp_raw_f9,
         naraAcc = nara_acc_raw_f9,
         wordAcc = read_word_raw_f9,
         nonwAcc = read_nonw_raw_f9,
         woldComp = wold_comp_raw_f8,
         f8age = age_m_f8,
         f9age = age_m_f9) %>% 
  
  # Change ID to a factor
  mutate(yp_id = as.factor(yp_id))
```

# Descriptive statistics

## Subsample A summary

Extract summary statistics for each variable. Note that these will not actually reflect the final reported statistics, given that we are working here with only half of the sample. 

```{r summary-stats}
describe(sv_data) %>% 
  round(2) %>% 
  kable("pipe")

vis_miss(sv_data, cluster = TRUE)
```

Patterns of missingness were more thoroughly explored for all WP1 variables in the initial data processing script. The only variable with significant missingness (~15%) is the WOLD listening comprehension variable, as it was collected at a different clinic visit. We showed in the earlier script that the data met the assumption of missing at random, as missingness could be predicted by other variables in the dataset. We will therefore deal with missing data by using full information maximum likelihood. 

```{r mplus-desc, include = FALSE}
# EXTRACT DESCRIPTIVE STATISTICS AS CHECK THAT MPLUS READING DATA PROPERLY

# Specify model
m_desc <- mplusObject(
  TITLE = "Data check - Descriptive statistics;",
  ANALYSIS = "type = basic;",
  usevariables = c("naraComp", "naraAcc", "wordAcc", "nonwAcc", "woldComp", "f8age", "f9age"),
  rdata = sv_data)

# Fit model 
m_desc_fit <- mplusModeler(m_desc,
                            dataout = "./mplus_models/simpview/desc/sv_sim.dat",
                            modelout = "./mplus_models/simpview/desc/sv_check.inp",
                            check = TRUE, run = FALSE, hashfilename = TRUE)

# Read mplus output
m_desc_out <- readModels("./mplus_models/simpview/desc/sv_check.out")

# Check that sample sizes and means match descriptive statistics from above
r_summ <- describe(sv_data) %>%
  as.data.frame() %>% 
  slice(3:9) %>% 
  dplyr::select(n, mean) %>% 
  round(., 2) %>%
  rownames_to_column(var = "task") %>% 
  arrange(task)

mplus_summ <- m_desc_out$sampstat$univariate.sample.statistics %>% 
  as.data.frame() %>%
  round(.,2) %>% 
  dplyr::select(`Sample Size`, Mean) %>%
  rownames_to_column(var = "task") %>% 
  arrange(task)

if (any((r_summ[,2:3] - mplus_summ[,2:3]) > abs(0.01))){  # allowing for rounding errors
  print("WARNING: DIFFERENCES DETECTED BETWEEN R AND MPLUS DATA SUMMARIES")
  } else{
      print("Data check passed")
  }

## (These differences were further inspected - only minor rounding errors; all observations accounted for)
```

# CFA (original measures)

## Factor structure

Test whether the data support the proposed two-factor model (accuracy, comprehension) over a single reading factor.

Each model additionally includes age as a covariate. Variance of the age variables was included in the models explicitly so that participants with missing session data are not excluded in mplus.  

```{r cfa-factor-structure}
# ONE-FACTOR MODEL
m_cfa1 <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - Single Factor;",
  ANALYSIS = "estimator = mlr; type = general;",                  
  MODEL = "f8age; f9age;
           read by naraComp naraAcc wordAcc nonwAcc woldComp;
           wordAcc nonwAcc naraAcc naraComp on f9age;
           woldcomp on f8age;",   # single reading factor, plus age covariates 
  OUTPUT = "sampstat; TECH1; TECH4; stdyx; modindices; ",
  PLOT = "TYPE = PLOT3;",
  usevariables = c("naraComp", "naraAcc", "wordAcc", "nonwAcc", "woldComp", "f8age", "f9age"),
  rdata = sv_data)

m_cfa1_fit <- mplusModeler(m_cfa1,
                           modelout = "./mplus_models/simpview/cfa/sv_cfa1.inp",
                           check = TRUE, run = FALSE)

# TWO-FACTOR MODEL
## Specify
m_cfa2 <- update(m_cfa1,
                 TITLE = ~ "Confirmatory Factor Analysis - Two-Factor;",
                 MODEL = ~ "f8age; f9age;
                            acc by nonwAcc wordAcc naraAcc; comp by woldComp naraComp;
                            wordAcc nonwAcc naraAcc naraComp on f9age;
                            woldcomp on f8age;
                            acc with comp;
                            f8age with acc@0; f8age with comp@0;
                            f9age with acc@0; f9age with comp@0;",  # age-factor covariances fixed to 0 for identifiability
                 
                 #DEFINE = ~ "naraAcc = naraAcc/10; naraComp = naraComp/5; # checked not scale issues
                 #             f8age = f8age/2; f9age = f9age/2;"
                 ) 
## Fit
m_cfa2_fit <- mplusModeler(m_cfa2,
                           modelout = "./mplus_models/simpview/cfa/sv_cfa2.inp",
                           check = TRUE, run = FALSE)

# COMPARE MODELS
cfa_models <- readModels(target = "./mplus_models/simpview/cfa", filefilter = "sv_cfa")

# Inspect for model errors
cfa_models$sv_cfa1.out$warnings
cfa_models$sv_cfa2.out$warnings
```

A number of solutions were tried to resolve the issues with the two-factor model, including freeing the factor loadings and rescaling the variables. However, the naraComp and woldComp variables do not sit will together as a comprehension factor (whereas naraComp sits better amongst the other reading variables).

On this basis, we will proceed with a Latent Profile Analysis, in line with the pre-registered plan. 

## Figure

```{r cfa-diagram, message = FALSE, warning = FALSE}
semPaths(semPlotModel(cfa_models$sv_cfa1.out, mplusStd = "stdyx"), what = "paths", whatLabels = "std", rotation = 1, intercepts = FALSE)
```

# CFA (composite accuracy measure)

After beginning the latent profile analysis, it became apparent that the discrete and skewed nature of the wordAcc variable was problematic for modelling (i.e., there was often insufficient variance to estimate for each of the classes).  We considered treating it as a categorical variable, but this was not easy to reconcile with our plan to estimate covariances across/within classes, and the skew meant that for the majority of profiles this was not a useful indicator on its own (often leading to warnings in Mplus). We therefore decided to combine the nonword and word reading item scores into a single measure of item accuracy (combAcc). 

The latent profile model remains the best approach (i.e., the composite accuracy measure does not remediate issues with the factor structure). Re-run here for completeness. 

## Composite accuracy measure

```{r comb-acc}
# Create combined score
sv_data <- sv_data %>% 
  mutate(combAcc = wordAcc+nonwAcc) %>% 
  select(-c(wordAcc, nonwAcc))

# Descriptives
describe(sv_data$combAcc) %>% 
  round(2) %>% 
  kable("pipe")
```

## One vs Two Factors

```{r cfa-compAcc}
# ONE-FACTOR MODEL
## Specify
m_cfa1 <- mplusObject(
  TITLE = "Confirmatory Factor Analysis - Single Factor (combAcc);",
  ANALYSIS = "estimator = mlr; type = general;",                  
  MODEL = "f8age; f9age;
           read by naraComp naraAcc combAcc woldComp;
           combAcc naraAcc naraComp on f9age;
           woldcomp on f8age;",   # single reading factor, plus age covariates 
  OUTPUT = "sampstat; TECH1; TECH4; stdyx; modindices; ",
  PLOT = "TYPE = PLOT3;",
  usevariables = c("naraComp", "naraAcc", "combAcc", "woldComp", "f8age", "f9age"),
  rdata = sv_data)

## Fit
m_cfa1_fit <- mplusModeler(m_cfa1,
                           modelout = "./mplus_models/simpview/cfa/sv_cfa1_comp.inp",
                           check = TRUE, run = FALSE)


# TWO-FACTOR MODEL
## Specify
m_cfa2 <- update(m_cfa1,
                 TITLE = ~ "Confirmatory Factor Analysis - Two-Factor (combAcc);",
                 MODEL = ~ "f8age; f9age;
                            acc by combAcc naraAcc; comp by woldComp naraComp;
                            combAcc naraAcc naraComp on f9age;
                            woldcomp on f8age;
                            acc with comp;
                            f8age with acc@0; f8age with comp@0;
                            f9age with acc@0; f9age with comp@0;",  # age-factor covariances fixed to 0 for identifiability
                 #DEFINE = ~ "naraAcc = naraAcc/10; naraComp = naraComp/5; # checked not scale issues
                 #             f8age = f8age/2; f9age = f9age/2;"
                 ) 
## Fit
m_cfa2_fit <- mplusModeler(m_cfa2,
                           modelout = "./mplus_models/simpview/cfa/sv_cfa2_comp.inp",
                           check = TRUE, run = TRUE)

# COMPARE MODELS
cfa_models <- readModels(target = "./mplus_models/simpview/cfa", filefilter = "sv_cfa")

# Inspect for model errors
cfa_models$sv_cfa1_comp.out$warnings
cfa_models$sv_cfa2_comp.out$warnings
```

## Figure

```{r cfa-compAcc-diagram, message = FALSE, warning = FALSE}
semPaths(semPlotModel(cfa_models$sv_cfa1_comp.out, mplusStd = "stdyx"), what = "paths", whatLabels = "std", rotation = 1, intercepts = FALSE)
```

# Version info {#version}

*Package versions were up-to-date as of 12/08/2021.* *LPA models were run using Mplus Version 8.5.*

```{r version}
sessionInfo()
```

